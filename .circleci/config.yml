version: '2.1'
orbs:
  node: circleci/node@5.2.0
  ruby: circleci/ruby@2.1.1
jobs:
  build:
    docker:
      - image: cimg/ruby:3.2.2-node
    steps:
      - checkout
      - ruby/install-deps
      - node/install-packages:
          pkg-manager: yarn
  checking:
    docker:
      - image: cimg/ruby:3.2.2-node
    parameters:
      app-dir:
        default: .
        description: >
          Path to the directory containing your Gemfile file. Not needed if Gemfile
          lives in the root.
        type: string
      check-path:
        default: .
        type: string
      out-path:
        default: /tmp/standardrb-results
        description: Customize the directory of output file
        type: string
      parallel:
        default: false
        description: |
          Use available CPUs to execute inspection in parallel.
        type: boolean
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: install standardrb
          command: |-
            gem install standardrb
      - run:
          name: standardrb lint
          command: |-
            #!/usr/bin/env bash
            
            mkdir -p "$PARAM_OUT_PATH"
            
            if [ "$PARAM_PARALLEL" -eq 0 ]; then
              bundle exec standardrb "$PARAM_CHECK_PATH" \
              --out $"$PARAM_OUT_PATH"/check-results.xml \
              --format "$PARAM_FORMAT"
            else
              bundle exec standardrb "$PARAM_CHECK_PATH" \
              --out $"$PARAM_OUT_PATH"/check-results.xml \
              --format "$PARAM_FORMAT" \
              --parallel
            fi
          environment:
            PARAM_CHECK_PATH: <<parameters.check-path>>
            PARAM_OUT_PATH: <<parameters.out-path>>
            PARAM_PARALLEL: <<parameters.parallel>>
            working_directory: <<parameters.app-dir>>
  test:
    docker:
      - image: cimg/ruby:3.2.2-node
      - environment:
          POSTGRES_DB: rails_blog_test
          POSTGRES_PASSWORD: ''
          POSTGRES_USER: circleci-demo-ruby
        image: circleci/postgres:9.5-alpine
    environment:
      BUNDLE_JOBS: '3'
      BUNDLE_RETRY: '3'
      PGHOST: 127.0.0.1
      PGPASSWORD: ''
      PGUSER: circleci-demo-ruby
      RAILS_ENV: test
    parallelism: 3
    steps:
      - checkout
      - ruby/install-deps
      - node/install-packages:
          pkg-manager: yarn
      - run:
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
          name: Wait for DB
      - run:
          command: bundle exec rails db:schema:load --trace
          name: Database setup
      - ruby/rspec-test:
          include: spec/**/*_spec.rb
workflows:
  build_and_test:
    jobs:
      - build
      - checking
      - test:
          requires:
            - build

